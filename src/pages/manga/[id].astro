---
import "@/styles/global.css";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import { fetchMangaDetail } from "@/lib/FetchManga";

export const prerender = false;

const { id } = Astro.params;
const mangaId = id ?? "";
if (!mangaId) return Astro.redirect("/manga");

const apiSecret =
  import.meta.env.API_SECRET ?? import.meta.env.PUBLIC_API_SECRET;
const data = await fetchMangaDetail(mangaId, apiSecret);
if (!data) return Astro.redirect("/manga");

const title = data.title ?? "Manga";
const description =
  data.synopsis?.paragraphs?.[0]?.slice(0, 160) ??
  data.indonesianTitle ??
  title;
const latestChapter = data.chapterList[0] ?? null;
const displayChapters = data.chapterList.slice(0, 10);
---

<html lang="id" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <title>Nebula - {title}</title>
    <meta name="description" content={description} />
    <meta property="og:title" content={title} />
    {data.poster && <meta property="og:image" content={data.poster} />}
    <link rel="preconnect" href="https://api.fontshare.com" />
  </head>

  <body class="min-h-screen bg-[#0a0b14] text-white antialiased">
    <div class="min-h-screen flex flex-col nebula-gradient-bg">
      <Header />

      <main class="mt-32 max-w-[1440px] mx-auto w-full px-6 grow pb-20">
        <!-- Hero Section -->
        <section class="flex flex-col lg:flex-row gap-12 animate-fade-up">
          <div class="w-full lg:w-[30%] shrink-0">
            <div
              class="relative aspect-3/4 rounded-2xl overflow-hidden group shadow-2xl glow-hover transition-all duration-500"
            >
              <img
                src={data.poster}
                alt={data.title}
                class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                width="400"
                height="533"
              />
              <div
                class="absolute inset-0 bg-linear-to-t from-[#0a0b14] via-transparent to-transparent opacity-60"
              >
              </div>
              <div class="absolute top-4 left-4">
                <span
                  class="px-3 py-1 bg-cyan-400 text-[#0a0b14] text-xs font-bold rounded-full uppercase tracking-wider"
                >
                  {data.mangaType}
                </span>
              </div>
            </div>
          </div>

          <div class="w-full lg:w-[70%] flex flex-col justify-between">
            <div>
              <div class="flex flex-wrap items-center gap-4 mb-4">
                <span
                  class="px-3 py-1 bg-purple-500/20 text-purple-400 text-xs font-bold rounded-md border border-purple-500/30"
                >
                  {data.status.toUpperCase()}
                </span>
                <span class="text-gray-500 text-sm">
                  {data.readerAge}
                </span>
              </div>
              <h1 class="text-4xl lg:text-6xl font-black leading-none mb-2">
                {data.title}
              </h1>
              {
                data.indonesianTitle && (
                  <p class="text-lg text-cyan-400 font-medium mb-4 italic">
                    {data.indonesianTitle}
                  </p>
                )
              }
              <p class="text-xl text-gray-400 font-medium mb-6">
                Oleh {data.author}
              </p>

              {
                data.genreList?.length > 0 && (
                  <div class="flex flex-wrap gap-3 mb-8">
                    {data.genreList.map((g) => (
                      <a
                        href={g.komikuUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="px-4 py-1.5 bg-white/5 border border-white/10 rounded-full text-sm text-gray-300 hover:border-cyan-400/50 hover:text-cyan-400 transition-colors"
                      >
                        {g.title}
                      </a>
                    ))}
                  </div>
                )
              }

              {
                data.synopsis?.paragraphs?.[0] && (
                  <p class="text-gray-400 text-lg leading-relaxed max-w-3xl mb-10">
                    {data.synopsis.paragraphs[0]}
                  </p>
                )
              }

              <div class="flex flex-wrap gap-4">
                {
                  latestChapter && (
                    <a
                      href={latestChapter.komikuUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="px-10 py-4 bg-cyan-400 hover:bg-cyan-300 text-[#0a0b14] font-bold rounded-full transition-all flex items-center gap-3 active:scale-95 group"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        class="group-hover:translate-x-0.5 transition-transform"
                      >
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                      </svg>
                      BACA SEKARANG
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        class="group-hover:translate-x-1 transition-transform"
                      >
                        <path d="M5 12h14" />
                        <path d="m12 5 7 7-7 7" />
                      </svg>
                    </a>
                  )
                }
                <button
                  type="button"
                  class="px-8 py-4 bg-white/5 hover:bg-white/10 text-white font-bold rounded-full border border-white/10 transition-all flex items-center gap-3"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M5 12h14"></path>
                    <path d="M12 5v14"></path>
                  </svg>
                  TAMBAH KE DAFTAR
                </button>
                <button
                  type="button"
                  class="p-4 bg-white/5 hover:bg-white/10 text-white rounded-full border border-white/10 transition-all"
                  aria-label="Share"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <path d="m8.59 13.51 6.82 3.98"></path>
                    <path d="M15.41 6.51l-6.82 3.98"></path>
                  </svg>
                </button>
              </div>
            </div>

            <div
              class="grid grid-cols-2 md:grid-cols-4 gap-8 mt-12 pt-8 border-t border-white/5"
            >
              <div>
                <p
                  class="text-gray-500 text-xs uppercase tracking-widest font-bold mb-1"
                >
                  Chapter
                </p>
                <p class="text-2xl font-bold">
                  {data.chapterList.length}
                  <span class="text-xs text-cyan-400 uppercase ml-1">total</span
                  >
                </p>
              </div>
              <div>
                <p
                  class="text-gray-500 text-xs uppercase tracking-widest font-bold mb-1"
                >
                  Arah Baca
                </p>
                <p class="text-2xl font-bold">{data.readingDirection}</p>
              </div>
              <div>
                <p
                  class="text-gray-500 text-xs uppercase tracking-widest font-bold mb-1"
                >
                  Pertama
                </p>
                <p class="text-2xl font-bold">{data.firstChapter}</p>
              </div>
              <div>
                <p
                  class="text-gray-500 text-xs uppercase tracking-widest font-bold mb-1"
                >
                  Terbaru
                </p>
                <p class="text-2xl font-bold">{data.latestChapter}</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Content Tabs & Lists -->
        <section class="mt-24 animate-fade-up" style="animation-delay: 0.2s">
          <div class="flex items-center gap-10 border-b border-white/5 mb-8">
            <span
              class="pb-4 text-cyan-400 border-b-2 border-cyan-400 font-bold tracking-wide text-lg"
            >
              CHAPTER
            </span>
            <span class="pb-4 text-gray-500 font-bold tracking-wide text-lg">
              REKOMENDASI
            </span>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
            <div class="lg:col-span-2">
              <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold">Rilis Terbaru</h3>
              </div>

              <!-- Daftar singkat (10 chapter) -->
              <div id="short-chapter-list">
                <div class="space-y-1">
                  {
                    displayChapters.map((chapter, index) => (
                      <a
                        href={`/manga/chapter/${chapter.chapterId}`}
                        class="chapter-row flex items-center justify-between p-4 rounded-xl transition-colors cursor-pointer group"
                      >
                        <div class="flex items-center gap-5">
                          <div class="w-12 h-12 bg-white/5 rounded-lg flex items-center justify-center group-hover:bg-cyan-400/20 transition-colors">
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="20"
                              height="20"
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              class="text-gray-500 group-hover:text-cyan-400"
                            >
                              <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20" />
                            </svg>
                          </div>
                          <div>
                            <p class="font-bold text-gray-200 group-hover:text-white">
                              {chapter.title}
                            </p>
                            <p class="text-xs text-gray-500">
                              Rilis {chapter.releaseDate} ·{" "}
                              {chapter.views.toLocaleString()} views
                            </p>
                          </div>
                        </div>
                        <div class="flex items-center gap-6">
                          {index === 0 && (
                            <span class="px-2 py-0.5 bg-cyan-400/10 text-cyan-400 text-[10px] font-bold rounded uppercase">
                              Baru
                            </span>
                          )}
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            class="text-gray-600 group-hover:text-white transition-colors"
                          >
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" y1="15" x2="12" y2="3" />
                          </svg>
                        </div>
                      </a>
                    ))
                  }
                </div>

                {
                  data.chapterList.length > 10 && (
                    <button
                      type="button"
                      id="btn-show-all-chapters"
                      class="w-full py-4 mt-8 bg-white/5 border border-white/10 rounded-xl hover:bg-white/10 transition-all font-bold text-gray-400 text-center"
                    >
                      LIHAT SEMUA {data.chapterList.length} CHAPTER
                    </button>
                  )
                }
              </div>

              <!-- Panel semua chapter dengan paginasi (tersembunyi awal) -->
              <div
                id="all-chapters-panel"
                class="hidden"
                data-total={data.chapterList.length}
              >
                <div
                  class="flex flex-wrap items-center justify-between gap-4 mb-6"
                >
                  <div class="flex items-center gap-4">
                    <span class="text-gray-500 text-sm">Tampilkan:</span>
                    <div
                      class="flex rounded-lg overflow-hidden border border-white/10"
                    >
                      <button
                        type="button"
                        data-per-page="25"
                        class="chapter-per-page-btn px-4 py-2 text-sm font-medium bg-cyan-400 text-[#0a0b14]"
                      >
                        25
                      </button>
                      <button
                        type="button"
                        data-per-page="50"
                        class="chapter-per-page-btn px-4 py-2 text-sm font-medium text-gray-400 hover:bg-white/5"
                      >
                        50
                      </button>
                    </div>
                    <span class="text-gray-500 text-sm">per halaman</span>
                  </div>
                  <div class="flex items-center gap-3">
                    <span id="chapter-page-info" class="text-sm text-gray-400">
                      Halaman 1 dari 1
                    </span>
                    <div class="flex gap-1">
                      <button
                        type="button"
                        id="chapter-prev"
                        class="p-2 rounded-lg bg-white/5 border border-white/10 text-gray-400 hover:bg-white/10 disabled:opacity-40 disabled:pointer-events-none"
                        aria-label="Sebelumnya"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="18"
                          height="18"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"><path d="m15 18-6-6 6-6"></path></svg
                        >
                      </button>
                      <button
                        type="button"
                        id="chapter-next"
                        class="p-2 rounded-lg bg-white/5 border border-white/10 text-gray-400 hover:bg-white/10 disabled:opacity-40 disabled:pointer-events-none"
                        aria-label="Berikutnya"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="18"
                          height="18"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"><path d="m9 18 6-6-6-6"></path></svg
                        >
                      </button>
                    </div>
                  </div>
                </div>

                <div id="all-chapters-list" class="space-y-1">
                  {
                    data.chapterList.map((chapter, index) => (
                      <a
                        href={`/manga/chapter/${chapter.chapterId}`}
                        class="chapter-row chapter-row-paginated flex items-center justify-between p-4 rounded-xl transition-colors cursor-pointer group"
                        data-index={index}
                      >
                        <div class="flex items-center gap-5">
                          <div class="w-12 h-12 bg-white/5 rounded-lg flex items-center justify-center group-hover:bg-cyan-400/20 transition-colors">
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="20"
                              height="20"
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              class="text-gray-500 group-hover:text-cyan-400"
                            >
                              <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20" />
                            </svg>
                          </div>
                          <div>
                            <p class="font-bold text-gray-200 group-hover:text-white">
                              {chapter.title}
                            </p>
                            <p class="text-xs text-gray-500">
                              Rilis {chapter.releaseDate} ·{" "}
                              {chapter.views.toLocaleString()} views
                            </p>
                          </div>
                        </div>
                        <div class="flex items-center gap-6">
                          {index === 0 && (
                            <span class="px-2 py-0.5 bg-cyan-400/10 text-cyan-400 text-[10px] font-bold rounded uppercase">
                              Baru
                            </span>
                          )}
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            class="text-gray-600 group-hover:text-white transition-colors"
                          >
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" y1="15" x2="12" y2="3" />
                          </svg>
                        </div>
                      </a>
                    ))
                  }
                </div>

                <div class="flex items-center justify-between gap-4 mt-6">
                  <button
                    type="button"
                    id="btn-back-short-list"
                    class="py-2 px-4 text-sm font-medium text-gray-400 hover:text-white border border-white/10 rounded-lg hover:bg-white/5 transition-colors"
                  >
                    ← Kembali ke ringkasan
                  </button>
                  <div
                    id="chapter-pagination-numbers"
                    class="flex flex-wrap justify-center gap-1"
                  >
                  </div>
                </div>
              </div>
            </div>

            <div class="space-y-10">
              <div>
                <h3 class="text-xl font-bold mb-6">Info Pengarang</h3>
                <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
                  <div class="flex items-center gap-4 mb-4">
                    <div
                      class="w-14 h-14 bg-purple-500 rounded-full flex items-center justify-center font-bold text-xl"
                    >
                      {data.author.slice(0, 2).toUpperCase()}
                    </div>
                    <div>
                      <p class="font-bold">{data.author}</p>
                      <p class="text-sm text-cyan-400">{data.mangaType}</p>
                    </div>
                  </div>
                  <p class="text-sm text-gray-500 mb-4">
                    Pengarang dari "{data.title}".
                  </p>
                  <button
                    type="button"
                    class="w-full py-2 bg-cyan-400 text-[#0a0b14] font-bold rounded-lg text-sm hover:bg-cyan-300 transition-colors"
                  >
                    IKUTI
                  </button>
                </div>
              </div>

              {
                data.similarMangaList?.length > 0 && (
                  <div>
                    <h3 class="text-xl font-bold mb-6">Manga Serupa</h3>
                    <div class="space-y-4">
                      {data.similarMangaList.slice(0, 5).map((similar) => (
                        <a
                          href={`/manga/${similar.mangaId}`}
                          class="flex gap-4 group"
                        >
                          <div class="w-20 h-28 bg-white/10 rounded-lg overflow-hidden shrink-0">
                            <img
                              src={similar.poster}
                              alt={similar.title}
                              class="w-full h-full object-cover group-hover:scale-110 transition-transform"
                              width="80"
                              height="112"
                              loading="lazy"
                            />
                          </div>
                          <div class="flex flex-col justify-center min-w-0">
                            <p class="font-bold group-hover:text-cyan-400 transition-colors truncate">
                              {similar.title}
                            </p>
                            <p class="text-xs text-gray-500 mb-1">
                              {similar.type}
                            </p>
                            <p class="text-xs text-gray-500 truncate">
                              {similar.views} views
                            </p>
                          </div>
                        </a>
                      ))}
                    </div>
                  </div>
                )
              }
            </div>
          </div>
        </section>
      </main>

      <Footer />

      <div class="lg:hidden fixed bottom-6 left-6 right-6 z-40">
        {
          latestChapter && (
            <a
              href={latestChapter.komikuUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="block w-full py-4 bg-cyan-400 text-[#0a0b14] font-bold rounded-2xl shadow-xl text-center"
            >
              BACA SEKARANG
            </a>
          )
        }
      </div>
    </div>

    <script define:vars={{ totalChapters: data.chapterList.length }}>
      (function () {
        if (totalChapters <= 10) return;

        const shortList = document.getElementById("short-chapter-list");
        const allPanel = document.getElementById("all-chapters-panel");
        const btnShowAll = document.getElementById("btn-show-all-chapters");
        const btnBack = document.getElementById("btn-back-short-list");
        const list = document.getElementById("all-chapters-list");
        const rows = list
          ? list.querySelectorAll(".chapter-row-paginated")
          : [];
        const pageInfo = document.getElementById("chapter-page-info");
        const prevBtn = document.getElementById("chapter-prev");
        const nextBtn = document.getElementById("chapter-next");
        const perPageBtns = document.querySelectorAll(".chapter-per-page-btn");
        const paginationNumbers = document.getElementById(
          "chapter-pagination-numbers",
        );

        let currentPage = 1;
        let perPage = 25;

        function totalPages() {
          return Math.max(1, Math.ceil(totalChapters / perPage));
        }

        function updateVisibility() {
          const start = (currentPage - 1) * perPage;
          const end = start + perPage;
          rows.forEach((row) => {
            const index = parseInt(row.getAttribute("data-index"), 10);
            const show = index >= start && index < end;
            if (show) row.removeAttribute("style");
            else row.setAttribute("style", "display: none");
          });
        }

        function updatePaginationUI() {
          const total = totalPages();
          if (pageInfo) {
            pageInfo.textContent = `Halaman ${currentPage} dari ${total}`;
          }
          if (prevBtn) {
            prevBtn.disabled = currentPage <= 1;
          }
          if (nextBtn) {
            nextBtn.disabled = currentPage >= total;
          }
          if (paginationNumbers) {
            paginationNumbers.innerHTML = "";
            const maxVisible = 5;
            let from = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let to = Math.min(total, from + maxVisible - 1);
            if (to - from + 1 < maxVisible)
              from = Math.max(1, to - maxVisible + 1);
            for (let p = from; p <= to; p++) {
              const btn = document.createElement("button");
              btn.type = "button";
              btn.className =
                "min-w-[2.25rem] py-2 px-2 rounded-lg text-sm font-medium transition-colors " +
                (p === currentPage
                  ? "bg-cyan-400 text-[#0a0b14]"
                  : "bg-white/5 border border-white/10 text-gray-400 hover:bg-white/10");
              btn.textContent = String(p);
              btn.addEventListener("click", () => {
                currentPage = p;
                updateVisibility();
                updatePaginationUI();
              });
              paginationNumbers.appendChild(btn);
            }
          }
          perPageBtns.forEach((btn) => {
            const n = parseInt(btn.getAttribute("data-per-page") || "25", 10);
            if (n === perPage) {
              btn.classList.add("bg-cyan-400", "text-[#0a0b14]");
              btn.classList.remove("text-gray-400");
            } else {
              btn.classList.remove("bg-cyan-400", "text-[#0a0b14]");
              btn.classList.add("text-gray-400");
            }
          });
        }

        function showAllChapters() {
          shortList?.classList.add("hidden");
          allPanel?.classList.remove("hidden");
          currentPage = 1;
          updateVisibility();
          updatePaginationUI();
        }

        function showShortList() {
          allPanel?.classList.add("hidden");
          shortList?.classList.remove("hidden");
        }

        btnShowAll?.addEventListener("click", showAllChapters);
        btnBack?.addEventListener("click", showShortList);

        perPageBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            perPage = parseInt(btn.getAttribute("data-per-page") || "25", 10);
            currentPage = 1;
            updateVisibility();
            updatePaginationUI();
          });
        });

        prevBtn?.addEventListener("click", () => {
          if (currentPage > 1) {
            currentPage--;
            updateVisibility();
            updatePaginationUI();
          }
        });
        nextBtn?.addEventListener("click", () => {
          if (currentPage < totalPages()) {
            currentPage++;
            updateVisibility();
            updatePaginationUI();
          }
        });
      })();
    </script>
  </body>
</html>
