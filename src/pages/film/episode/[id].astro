---
import "@/styles/global.css";

import Header from "@/components/layout/Header.astro";

import Footer from "@/components/layout/Footer.astro";

import {
  fetchFilmEpisodeDetail,
  fetchFilmServerStreamUrl,
} from "@/lib/FetchFIlm";

export const prerender = false;

const { id } = Astro.params;
const episodeId = id ?? "";
if (!episodeId) return Astro.redirect("/");

const apiSecret =
  import.meta.env.API_SECRET ?? import.meta.env.PUBLIC_API_SECRET ?? "";
const episode = await fetchFilmEpisodeDetail(episodeId, { apiSecret });

if (!episode) {
  return Astro.redirect("/");
}

const title = episode.title ?? "Episode";
const episodeList = episode.episodeList ?? [];
const currentEpisodeIndex = episodeList.findIndex(
  (e) => e.episodeId === episodeId,
);
const prevEpisode =
  currentEpisodeIndex > 0 ? episodeList[currentEpisodeIndex - 1] : null;
const nextEpisode =
  currentEpisodeIndex >= 0 && currentEpisodeIndex < episodeList.length - 1
    ? episodeList[currentEpisodeIndex + 1]
    : null;

// Extract film ID from episodeId pattern
// e.g., "jujutsu-kaisen-s1-e01" -> try to get base film ID
// For now, we'll try to extract by removing episode suffix patterns
const episodeIdParts = episodeId.split("-");
let filmId: string | null = null;

// Try to find film ID from episodeId by removing common episode patterns
// Patterns: -s1-e01, -season-1-episode-5-2, etc.
if (episodeIdParts.length > 2) {
  // Remove last 2-4 parts that might be episode identifiers
  const possibleFilmId = episodeIdParts.slice(0, -2).join("-");
  filmId = possibleFilmId || null;
}

// Resolve stream URL untuk tiap server (pakai FetchFIlm, tidak perlu API route)
type ServerWithUrl = {
  title: string;
  serverId: string;
  href: string;
  streamUrl: string | null;
};
type QualityWithServers = { title: string; servers: ServerWithUrl[] };
const serverQualitiesWithUrls: QualityWithServers[] = episode.server?.qualities
  ? await Promise.all(
      episode.server.qualities.map(async (quality) => ({
        title: quality.title,
        servers: await Promise.all(
          quality.serverList.map(async (server) => ({
            ...server,
            streamUrl: await fetchFilmServerStreamUrl(server.serverId, {
              apiSecret,
            }),
          })),
        ),
      })),
    )
  : [];
---

<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <title>{title} | Zona Nonton</title>
    <meta
      name="description"
      content={`Nonton ${title} streaming online gratis di Zona Nonton.`}
    />
  </head>

  <body
    class="min-h-screen bg-(--bg-deep) text-white overflow-x-hidden font-['Satoshi',sans-serif]"
  >
    <Header />

    <main class="max-w-7xl mx-auto px-6 lg:px-12 py-8 pt-24">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        {/* Main Content */}
        <div class="lg:col-span-3 space-y-6">
          {/* Episode Title & Navigation */}
          <div
            class="flex flex-col sm:flex-row sm:items-center justify-between gap-4"
          >
            <div>
              <h1
                class="text-3xl lg:text-4xl font-extrabold mb-2 font-['Cabinet_Grotesk',sans-serif] text-gradient-cyan"
              >
                {episode.title}
              </h1>
              {
                episode.aquaaquariaId && (
                  <p class="text-sm text-white/60">
                    ID: {episode.aquaaquariaId}
                  </p>
                )
              }
            </div>
            <div class="flex items-center gap-3">
              {
                prevEpisode && (
                  <a
                    href={`/film/episode/${prevEpisode.episodeId}`}
                    class="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg transition-colors text-sm font-medium"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <polyline points="15 18 9 12 15 6" />
                    </svg>
                    Prev
                  </a>
                )
              }
              {
                nextEpisode && (
                  <a
                    href={`/film/episode/${nextEpisode.episodeId}`}
                    class="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg transition-colors text-sm font-medium"
                  >
                    Next
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <polyline points="9 18 15 12 9 6" />
                    </svg>
                  </a>
                )
              }
            </div>
          </div>

          {
            /* Video Player - iframe src can be updated when user picks a server */
          }
          <div
            class="bg-black/40 rounded-2xl overflow-hidden border border-white/10"
          >
            <iframe
              id="episode-player"
              src={episode.defaultStream &&
              episode.defaultStream !== "about:blank"
                ? episode.defaultStream
                : "about:blank"}
              class="w-full aspect-video"
              allowfullscreen
              allow="autoplay; fullscreen"
              title={title}></iframe>
          </div>

          {
            /* Server Selection - stream URL sudah di-resolve di server pakai FetchFIlm */
          }
          {
            serverQualitiesWithUrls.length > 0 && (
              <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
                <h3 class="text-xl font-bold mb-4 font-['Cabinet_Grotesk',sans-serif]">
                  Streaming Servers
                </h3>
                <div class="space-y-4">
                  {serverQualitiesWithUrls.map((quality) => (
                    <div>
                      <h4 class="text-sm font-bold text-white/80 mb-3 uppercase tracking-wider">
                        {quality.title}
                      </h4>
                      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        {quality.servers.map((server) => (
                          <button
                            type="button"
                            data-stream-url={server.streamUrl ?? undefined}
                            class="episode-server-btn px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg transition-colors text-sm font-medium text-center disabled:opacity-50 disabled:cursor-not-allowed data-active:bg-cyan-400/20 data-active:border-cyan-400/40 data-active:text-cyan-400"
                            disabled={!server.streamUrl}
                          >
                            {server.title}
                          </button>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )
          }

          {/* Back to Film */}
          {
            filmId && (
              <div class="pt-4">
                <a
                  href={`/film/${filmId}`}
                  class="inline-flex items-center gap-2 text-cyan-400 hover:text-cyan-300 transition-colors text-sm font-medium"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <polyline points="15 18 9 12 15 6" />
                  </svg>
                  Back to Film Details
                </a>
              </div>
            )
          }
        </div>

        {/* Episode List Sidebar */}
        {
          episodeList.length > 0 && (
            <aside class="lg:col-span-1">
              <div class="bg-white/5 border border-white/10 rounded-2xl p-6 sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto custom-scrollbar">
                <h3 class="text-lg font-bold mb-4 font-['Cabinet_Grotesk',sans-serif]">
                  Episodes
                </h3>
                <div class="space-y-2">
                  {episodeList.map((ep) => (
                    <a
                      href={`/film/episode/${ep.episodeId}`}
                      class={`block px-4 py-3 rounded-lg transition-colors text-sm font-medium ${
                        ep.episodeId === episodeId
                          ? "bg-cyan-400/20 border border-cyan-400/40 text-cyan-400"
                          : "bg-white/5 hover:bg-white/10 border border-white/10 text-white/80 hover:text-white"
                      }`}
                    >
                      <div class="flex items-center justify-between">
                        <span class="font-bold">{ep.title}</span>
                        {ep.episodeId === episodeId && (
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            class="text-cyan-400"
                          >
                            <polygon points="5 3 19 12 5 21 5 3" />
                          </svg>
                        )}
                      </div>
                    </a>
                  ))}
                </div>
              </div>
            </aside>
          )
        }
      </div>
    </main>

    <Footer />

    <script>
      const serverBtns = document.querySelectorAll(
        ".episode-server-btn[data-stream-url]",
      );
      const player = document.getElementById(
        "episode-player",
      ) as HTMLIFrameElement | null;

      serverBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const url = btn.getAttribute("data-stream-url");
          if (!url || !player) return;
          serverBtns.forEach((b) => b.removeAttribute("data-active"));
          btn.setAttribute("data-active", "");
          player.src = url;
        });
      });
    </script>
  </body>
</html>
