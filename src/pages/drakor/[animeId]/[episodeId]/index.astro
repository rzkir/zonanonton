---
import "@/styles/global.css";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import {
  fetchDrakorEpisodeDetail,
  fetchDrakorServerStreamUrl,
} from "@/lib/FetchDrakor";

export const prerender = false;

const { animeId, episodeId } = Astro.params;
const slug = animeId ?? "";
const epNum = episodeId ?? "";
if (!slug || !epNum) return Astro.redirect("/");

const apiSecret =
  import.meta.env.API_SECRET ?? import.meta.env.PUBLIC_API_SECRET ?? "";
const episode = await fetchDrakorEpisodeDetail(slug, epNum, { apiSecret });

if (!episode) {
  return Astro.redirect("/drakor");
}

/** Parse API episodeId "anime-slug/num" into our route segments for /drakor/[animeId]/[episodeId] */
function toDrakorEpisodeHref(apiEpisodeId: string): string {
  const idx = apiEpisodeId.lastIndexOf("/");
  if (idx === -1) return `/drakor/${slug}/${epNum}`;
  const s = apiEpisodeId.slice(0, idx);
  const n = apiEpisodeId.slice(idx + 1);
  return `/drakor/${encodeURIComponent(s)}/${encodeURIComponent(n)}`;
}

const title = `Episode ${epNum}`;
const episodeList = episode.episodeList ?? [];
const prevEpisode = episode.prevEpisode ?? null;
const nextEpisode = episode.nextEpisode ?? null;

type ServerWithUrl = {
  title: string;
  serverId: string;
  href: string;
  streamUrl: string | null;
};
type QualityWithServers = { title: string; servers: ServerWithUrl[] };
const serverQualitiesWithUrls: QualityWithServers[] = episode.qualities
  ? await Promise.all(
      episode.qualities.map(async (quality) => ({
        title: quality.title,
        servers: await Promise.all(
          quality.serverList.map(async (server) => ({
            ...server,
            streamUrl: await fetchDrakorServerStreamUrl(
              server.serverId,
              server.href,
              { apiSecret },
            ),
          })),
        ),
      })),
    )
  : [];
---

<html lang="id" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <title>{title} â€“ {slug} | Zona Nonton</title>
    <meta
      name="description"
      content={`Nonton ${title} ${slug} streaming online gratis.`}
    />
  </head>

  <body
    class="min-h-screen bg-(--bg-deep) text-white overflow-x-hidden font-['Satoshi',sans-serif]"
  >
    <Header />

    <main class="max-w-7xl mx-auto px-6 lg:px-12 py-8 pt-24">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <div class="lg:col-span-3 space-y-6">
          <div
            class="flex flex-col sm:flex-row sm:items-center justify-between gap-4"
          >
            <div>
              <h1
                class="text-3xl lg:text-4xl font-extrabold mb-2 font-['Cabinet_Grotesk',sans-serif] text-gradient-cyan"
              >
                {title}
              </h1>
              <p class="text-sm text-white/60">{slug}</p>
            </div>
            <div class="flex items-center gap-3">
              {
                prevEpisode && (
                  <a
                    href={toDrakorEpisodeHref(prevEpisode.episodeId)}
                    class="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg transition-colors text-sm font-medium"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <polyline points="15 18 9 12 15 6" />
                    </svg>
                    Prev
                  </a>
                )
              }
              {
                nextEpisode && (
                  <a
                    href={toDrakorEpisodeHref(nextEpisode.episodeId)}
                    class="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg transition-colors text-sm font-medium"
                  >
                    Next
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <polyline points="9 18 15 12 9 6" />
                    </svg>
                  </a>
                )
              }
            </div>
          </div>

          <div
            class="bg-black/40 rounded-2xl overflow-hidden border border-white/10"
          >
            <iframe
              id="episode-player"
              src={episode.defaultStreamingUrl &&
              episode.defaultStreamingUrl !== "about:blank"
                ? episode.defaultStreamingUrl
                : "about:blank"}
              class="w-full aspect-video"
              allowfullscreen
              allow="autoplay; fullscreen"
              title={title}></iframe>
          </div>

          {
            serverQualitiesWithUrls.length > 0 && (
              <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
                <h3 class="text-xl font-bold mb-4 font-['Cabinet_Grotesk',sans-serif]">
                  Streaming Servers
                </h3>
                <div class="space-y-4">
                  {serverQualitiesWithUrls.map((quality) => (
                    <div>
                      <h4 class="text-sm font-bold text-white/80 mb-3 uppercase tracking-wider">
                        {quality.title}
                      </h4>
                      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        {quality.servers.map((server) => (
                          <button
                            type="button"
                            data-stream-url={server.streamUrl ?? undefined}
                            class="episode-server-btn px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg transition-colors text-sm font-medium text-center disabled:opacity-50 disabled:cursor-not-allowed data-active:bg-cyan-400/20 data-active:border-cyan-400/40 data-active:text-cyan-400"
                            disabled={!server.streamUrl}
                          >
                            {server.title}
                          </button>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )
          }

          <div class="pt-4">
            <a
              href={`/drakor/${encodeURIComponent(slug)}`}
              class="inline-flex items-center gap-2 text-cyan-400 hover:text-cyan-300 transition-colors text-sm font-medium"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
              Kembali ke Detail Drama
            </a>
          </div>
        </div>

        {
          episodeList.length > 0 && (
            <aside class="lg:col-span-1">
              <div class="bg-white/5 border border-white/10 rounded-2xl p-6 sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto custom-scrollbar">
                <h3 class="text-lg font-bold mb-4 font-['Cabinet_Grotesk',sans-serif]">
                  Daftar Episode
                </h3>
                <div class="space-y-2">
                  {episodeList.map((ep) => {
                    const href = toDrakorEpisodeHref(ep.episodeId);
                    const isActive =
                      ep.episodeId === `${slug}/${epNum}` || ep.is_active;
                    return (
                      <a
                        href={href}
                        class={`block px-4 py-3 rounded-lg transition-colors text-sm font-medium ${
                          isActive
                            ? "bg-cyan-400/20 border border-cyan-400/40 text-cyan-400"
                            : "bg-white/5 hover:bg-white/10 border border-white/10 text-white/80 hover:text-white"
                        }`}
                      >
                        <div class="flex items-center justify-between">
                          <span class="font-bold">{ep.episodeTitle}</span>
                          {isActive && (
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="16"
                              height="16"
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              class="text-cyan-400"
                            >
                              <polygon points="5 3 19 12 5 21 5 3" />
                            </svg>
                          )}
                        </div>
                      </a>
                    );
                  })}
                </div>
              </div>
            </aside>
          )
        }
      </div>
    </main>

    <Footer />

    <script is:inline>
      function initServerButtons() {
        var player = document.getElementById("episode-player");
        var serverBtns = document.querySelectorAll(".episode-server-btn");
        if (!player || !serverBtns.length) return;

        function setActiveServer(activeBtn) {
          for (var i = 0; i < serverBtns.length; i++) {
            serverBtns[i].removeAttribute("data-active");
          }
          if (activeBtn) activeBtn.setAttribute("data-active", "true");
        }

        var currentSrc = player.src || "";
        if (currentSrc) {
          for (var j = 0; j < serverBtns.length; j++) {
            var url = serverBtns[j].getAttribute("data-stream-url");
            if (url && url === currentSrc) {
              setActiveServer(serverBtns[j]);
              break;
            }
          }
        }

        for (var k = 0; k < serverBtns.length; k++) {
          (function (btn) {
            btn.addEventListener("click", function () {
              var url = btn.getAttribute("data-stream-url");
              if (!url || !player) return;
              setActiveServer(btn);
              player.src = url;
            });
          })(serverBtns[k]);
        }
      }
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initServerButtons);
      } else {
        initServerButtons();
      }
    </script>
  </body>
</html>
